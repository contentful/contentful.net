version: 2.1

jobs:
  test:
    parameters:
      dotnet-version:
        type: string
    docker:
      - image: mcr.microsoft.com/dotnet/sdk:<< parameters.dotnet-version >>
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            apt-get update && apt-get install -y ssh git
      - run:
          name: Show .NET version
          command: dotnet --version
      - run:
          name: Restore dependencies
          command: dotnet restore
      - run:
          name: Build and test .NET << parameters.dotnet-version >>
          command: |
            FRAMEWORK_VERSION=$(echo << parameters.dotnet-version >> | cut -d. -f1,2)
            # Build the library projects (they target netstandard2.0)
            dotnet build Contentful.Core/Contentful.Core.csproj --no-restore
            dotnet build Contentful.AspNetCore/Contentful.AspNetCore.csproj --no-restore
            # Temporarily update test project files to target the current .NET version
            sed -i "s/<TargetFramework>net8.0<\/TargetFramework>/<TargetFramework>net$FRAMEWORK_VERSION<\/TargetFramework>/g" Contentful.Core.Tests/Contentful.Core.Tests.csproj
            sed -i "s/<TargetFramework>net8.0<\/TargetFramework>/<TargetFramework>net$FRAMEWORK_VERSION<\/TargetFramework>/g" Contentful.AspNetCore.Tests/Contentful.AspNetCore.Tests.csproj
            # Build and test the test projects
            dotnet build Contentful.Core.Tests/Contentful.Core.Tests.csproj --no-restore
            dotnet build Contentful.AspNetCore.Tests/Contentful.AspNetCore.Tests.csproj --no-restore
            dotnet test Contentful.Core.Tests/Contentful.Core.Tests.csproj --no-build --verbosity normal --logger trx --results-directory test-results
            dotnet test Contentful.AspNetCore.Tests/Contentful.AspNetCore.Tests.csproj --no-build --verbosity normal --logger trx --results-directory test-results
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: test-results

workflows:
  version: 2
  test-matrix:
    jobs:
      - test:
          matrix:
            parameters:
              dotnet-version: ["8.0.412", "9.0.100"]
          name: test-dotnet-<< matrix.dotnet-version >>
