version: 2.1

jobs:
  test:
    parameters:
      dotnet-version:
        type: string
    docker:
      - image: mcr.microsoft.com/dotnet/sdk:<< parameters.dotnet-version >>
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            apt-get update && apt-get install -y ssh git
      - run:
          name: Show .NET version
          command: dotnet --version
      - run:
          name: Restore dependencies
          command: dotnet restore
      - run:
          name: Build and test .NET << parameters.dotnet-version >>
          command: |
            FRAMEWORK_VERSION=$(echo << parameters.dotnet-version >> | cut -d. -f1,2)
            dotnet build --no-restore --framework net$FRAMEWORK_VERSION
            dotnet test Contentful.Core.Tests/Contentful.Core.Tests.csproj --no-build --framework net$FRAMEWORK_VERSION --verbosity normal --logger trx --results-directory test-results
            dotnet test Contentful.AspNetCore.Tests/Contentful.AspNetCore.Tests.csproj --no-build --framework net$FRAMEWORK_VERSION --verbosity normal --logger trx --results-directory test-results
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: test-results

workflows:
  version: 2
  test-matrix:
    jobs:
      - test:
          matrix:
            parameters:
              dotnet-version: ["8.0.412", "9.0.100"]
          name: test-dotnet-<< matrix.dotnet-version >>
