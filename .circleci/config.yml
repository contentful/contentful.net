version: 2.1

jobs:
  test:
    parameters:
      dotnet-version:
        type: string
    docker:
      - image: mcr.microsoft.com/dotnet/sdk:<< parameters.dotnet-version >>
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            apt-get update && apt-get install -y ssh git
      - run:
          name: Show .NET version
          command: dotnet --version
      - run:
          name: Restore dependencies
          command: dotnet restore
      - run:
          name: Build
          command: dotnet build --no-restore
      - run:
          name: Run Contentful.Core tests
          command: dotnet test Contentful.Core.Tests/Contentful.Core.Tests.csproj --no-build --verbosity normal --logger trx --results-directory test-results
      - run:
          name: Run Contentful.AspNetCore tests
          command: dotnet test Contentful.AspNetCore.Tests/Contentful.AspNetCore.Tests.csproj --no-build --verbosity normal --logger trx --results-directory test-results
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: test-results

workflows:
  version: 2
  test-matrix:
    jobs:
      - test:
          matrix:
            parameters:
              dotnet-version: ["8.0.412", "9.0.100"]
          name: test-dotnet-<< matrix.dotnet-version >>
